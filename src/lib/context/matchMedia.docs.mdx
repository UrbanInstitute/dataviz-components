import { Meta } from "@storybook/addon-docs/blocks";

<Meta title="context/matchMedia" />

# Media Query Context (matchMedia)

[![github](https://badgen.net/badge/icon/GitHub?icon=github&label)](https://github.com/UrbanInstitute/dataviz-components/blob/main/src/lib/context/matchMediaContext.svelte.js)

A rune-based context module that tracks media query preferences using the browser's `window.matchMedia()` API, adapted from [Geoff Rich's Accessible Svelte Transitions article](https://geoffrich.net/posts/accessible-svelte-transitions/).

This module currently tracks the user's `prefers-reduced-motion` preference, with a design that supports adding additional media queries in the future (e.g., `prefers-color-scheme`, `prefers-contrast`, viewport sizes).

## Usage

This module provides two functions for managing media query context:

- `createMatchMediaContext()` - Creates and initializes the media query context. Call this once at the root of your component tree (e.g., in your app layout).
- `useMatchMediaContext()` - Gets the media query context. Call this in any child component that needs to access media query preferences.

### Setup

First, initialize the media query context in your root layout:

```svelte
<!-- +layout.svelte -->
<script>
  import { createMatchMediaContext } from "@urbaninstitute/dataviz-components/context";

  // Initialize media query context for the entire app
  createMatchMediaContext();
</script>
```

### Using in Components

Then, in any child component, access the media query context:

```svelte
<script>
  import { useMatchMediaContext } from "@urbaninstitute/dataviz-components/context";
  import { tweened } from "svelte/motion";
  import { cubicOut } from "svelte/easing";

  const media = useMatchMediaContext();

  const tween = tweened(0, {
    duration: media.reducedMotion ? 0 : 500,
    easing: cubicOut
  });
</script>
```

### Available Properties

The media query context currently provides:

- `reducedMotion` (boolean) - `true` when the user has enabled "prefers-reduced-motion" in their accessibility settings

## Additional CSS for prefers-reduced-motion

It's worth noting that CSS like the following will disable most native Svelte transitions and animations. The `reducedMotion` state above is useful if an animation function is not covered by this media query.

```css
@media (prefers-reduced-motion: reduce) {
  * {
    animation-delay: 0ms !important;
    animation-duration: 1ms !important;
    transition: none !important;
  }
}
```

## Deprecated API

> **Warning:** The legacy `reducedMotion` readable store is deprecated and will be removed in a future major version. Please migrate to `createMatchMediaContext()`/`useMatchMediaContext()` as shown above.

For backward compatibility, the legacy Svelte 4 readable store is still available:

```svelte
<script>
  import { reducedMotion } from "@urbaninstitute/dataviz-components/stores";
  import { tweened } from "svelte/motion";
  import { cubicOut } from "svelte/easing";

  const tween = tweened(0, {
    duration: $reducedMotion ? 0 : 500,
    easing: cubicOut
  });
</script>
```

**Migration path:**

This legacy pattern requires no setup and uses Svelte's `$store` subscription syntax. However, it does not clean up properly in all contexts and doesn't support multiple component trees.

To migrate:

1. Add `createMatchMediaContext()` to your root layout (one time setup)
2. Replace `import { reducedMotion }` with `import { useMatchMediaContext }` from `@urbaninstitute/dataviz-components/context`
3. Replace `$reducedMotion` with `media.reducedMotion` (where `const media = useMatchMediaContext()`)

See the [breaking changes log](https://github.com/UrbanInstitute/dataviz-components/blob/main/docs/runes-breaking-changes.md) for complete migration examples.
