import * as Stories from "./Scrolly.stories.svelte";
import { Meta, Controls, ArgTypes, Markdown, Story } from "@storybook/addon-docs/blocks";

<Meta of={Stories} />

# Scrolly

A component that can be used to create "scrolly" sections and pages. This component is a wrapper around the [svelte-scroller](https://github.com/sveltejs/svelte-scroller) library. If your project has needs that go beyond what this component can support, you should consider using `svelte-scroller` directly. But for many common scenarious, the options provided here should have you covered.

Basic usage:

```svelte
<script>
  import { Scrolly } from "@urbaninstitute/dataviz-components";

  const slides = ["Slide 1", "Slide 2", "Slide 3"];
</script>

<Scrolly {slides}>
  {#snippet background()}
    <div
      style="width: 100%; height: 100vh; color: var(--color-white); font-weight: var(--font-weight-bold); background: var(--color-blue); display: flex; align-items: center; justify-content: center;"
    >
      Scrolly background
    </div>
  {/snippet}
</Scrolly>
```

<Story of={Stories.Primary} />
<Controls />

## Background components

While this component provides much of what you need to get started with a scrolly segment, you'll need to create your own background component. This can range from a very simple component that displays an image or a chart, to something highly complex with bespoke animations and transitions. The sky is the limit, and how you build your background component is up to you and the needs of your project. There are a few core pieces of functionality this component provides that will help you out. The `<Scrolly>` component provides key information about the current state of the scrolly via [Svelte's context API](https://svelte.dev/docs/svelte#setcontext), accessible through the `useScrollyState()` helper function. This means you don't need to worry about `let` bindings or passing the correct props to your background component inside your app. The following properties can be accessed from inside your background component:

<Markdown>
  {`| property    | description                                                                                   |
| ----------- | --------------------------------------------------------------------------------------------- |
| index       | The index of the current slide. This variable can be used to determine what content should be displayed in the background|
| offset      | How far the section has scrolled past the threshold, as a value between 0 and 1. |
| progress    | How far the foreground has travelled, where 0 is the top of the foreground crossing \`top\`, and 1 is the bottom crossing \`bottom\`.|
| slideHeight | The height in pixels of the current slide based on browser conditions. Can be used for sizing content in the background.|
| slideWidth  | The width in pixels of the current slide based on browser conditions. Can be used for sizing content in the background.|
| innerHeight | The viewable area of the window in pixels.|
`}
</Markdown>

You can access these values by calling the `useScrollyState()` helper function from within your background component:

```svelte
<script>
  import { useScrollyState } from "@urbaninstitute/dataviz-components";

  // Access scrolly state from context
  const scrolly = useScrollyState();

  // Use scrolly state properties directly (they are reactive)
  console.log("The current index is", scrolly.index);
  console.log("The slideWidth is", scrolly.slideWidth);
</script>

<div>
  Current slide: {scrolly.index}
</div>
```

**Note:** This is a breaking change from previous versions. The old API using `getContext("scrolly")` with Svelte stores is no longer supported. See the migration guide below for upgrade instructions.

## Custom foregrounds

By default, the foreground expects a simple string in the `slides` array, and it renders the provided string (including any HTML formatting) within a `<p>` element inside a basic text box. This default behaviour will work for many scenarios, but you might need more flexibility beyond including simple inline HTML inside a `<p>`. If this is the case, you can override the default markup by making use of the `foreground` snippet prop. Additionally, you can pass more complex data structures through the `slides` prop and specify how these data should be rendered with a custom `foreground` snippet. The contents of the corresponding item in the array will be passed to your foreground snippet along with the slide index. You can use this data in your custom markup like so:

```svelte
<script>
  import { Scrolly } from "@urbaninstitute/dataviz-components";

  let slides = [
    {
      title: "Slide 1",
      body: "This is the body of slide 1"
    },
    {
      title: "Slide 2",
      body: "This is the body of slide 2"
    },
    {
      title: "Slide 3",
      body: "This is the body of slide 3"
    }
  ];
</script>

<Scrolly {slides}>
  {#snippet background()}
    <div
      style="width: 100%; height: 100vh; color: var(--color-white); font-weight: var(--font-weight-bold); background: var(--color-blue); display: flex; align-items: center; justify-content: center;"
    >
      Scrolly background
    </div>
  {/snippet}

  {#snippet foreground(slide, index)}
    <div class="custom-foreground-text-box">
      <h2>{slide.title}</h2>
      <p>{slide.body}</p>
      <small>Slide {index + 1}</small>
    </div>
  {/snippet}
</Scrolly>
```

## Migration Guide

If you're upgrading from a previous version of this component, here are the breaking changes and how to update your code:

### 1. Background slot → background snippet

**Before:**

```svelte
<Scrolly {slides}>
  <div slot="background">Background content</div>
</Scrolly>
```

**After:**

```svelte
<Scrolly {slides}>
  {#snippet background()}
    <div>Background content</div>
  {/snippet}
</Scrolly>
```

### 2. Foreground slot → foreground snippet

**Before:**

```svelte
<Scrolly {slides}>
  <div slot="foreground" let:slide>
    <h2>{slide.title}</h2>
  </div>
</Scrolly>
```

**After:**

```svelte
<Scrolly {slides}>
  {#snippet foreground(slide, index)}
    <div>
      <h2>{slide.title}</h2>
    </div>
  {/snippet}
</Scrolly>
```

### 3. Context API: getContext → useScrollyState

**Before:**

```svelte
<script>
  import { getContext } from "svelte";

  const { index, offset, progress, slideHeight, slideWidth } = getContext("scrolly");

  // Use with $ store syntax
  console.log($index);
</script>
```

**After:**

```svelte
<script>
  import { useScrollyState } from "@urbaninstitute/dataviz-components";

  const scrolly = useScrollyState();

  // Use properties directly (reactive)
  console.log(scrolly.index);
</script>
```
