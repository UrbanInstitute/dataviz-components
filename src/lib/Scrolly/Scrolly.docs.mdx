import * as Stories from "./Scrolly.stories.svelte";
import { Meta, Controls, ArgTypes, Markdown, Story } from "@storybook/addon-docs/blocks";

<Meta of={Stories} />

# Scrolly

A component that can be used to create "scrolly" sections and pages. This component is a wrapper around the [svelte-scroller](https://github.com/sveltejs/svelte-scroller) library with a rune-based `ScrollyState` context under the hood. If you need behavior beyond what is provided here, compose directly with `svelte-scroller`, but for most editorial scrollytelling use cases this component is designed to be the starting point. Customization happens through snippet props and the context helper described below.

Basic usage:

```svelte
<script>
  import { Scrolly } from "@urbaninstitute/dataviz-components";

  const slides = ["Slide 1", "Slide 2", "Slide 3"];
</script>

<Scrolly {slides}>
  {#snippet background()}
    <div
      style="width: 100%; height: 100vh; color: var(--color-white); font-weight: var(--font-weight-bold); background: var(--color-blue); display: flex; align-items: center; justify-content: center;"
    >
      Scrolly background
    </div>
  {/snippet}
</Scrolly>
```

<Story of={Stories.Primary} />
<Controls />

## Background components

While this component provides much of what you need to get started with a scrolly segment, you'll supply your own background functionality via the `background` snippet. The `<Scrolly>` component creates a rune-based state class (`createScrollyState()`) and exposes it through the `useScrollyState()` helper. Call that helper inside any descendant (for example, your background component) to read reactive values without juggling stores or prop drilling. The state instance exposes the following properties:

<Markdown>
  {`| property    | description                                                                                   |
| ----------- | --------------------------------------------------------------------------------------------- |
| index       | The zero-based index of the active slide. Use this to coordinate scene changes in the background.|
| offset      | How far the current slide has scrolled past the threshold (0–1). Useful for triggering progressive animations.|
| progress    | How far the foreground has travelled overall, where 0 is the top crossing \`top\` and 1 is the bottom crossing \`bottom\`.|
| slideHeight | The height in pixels of the current slide. Use for sizing or positioning background content.|
| slideWidth  | The width in pixels of the current slide.|
| innerHeight | The viewport height in pixels.|
`}
</Markdown>

Access these values by calling the `useScrollyState()` helper function from within a descendant component or snippet:

```svelte
<script>
  import { useScrollyState } from "@urbaninstitute/dataviz-components";
  const scrolly = useScrollyState();
</script>

<div>
  <p>Current slide: {scrolly.index + 1}</p>
  <p>Progress: {Math.round(scrolly.progress * 100)}%</p>
</div>
```

**Note:** This is a breaking change from previous versions. The old API using `getContext("scrolly")` with Svelte stores is no longer supported. See the migration guide below for upgrade instructions.

## Custom foregrounds

By default, the foreground expects a simple string in the `slides` array, and it renders the provided string (including any HTML formatting) within a `<p>` element inside a basic text box. This default behaviour will work for many scenarios, but you might need more flexibility beyond including simple inline HTML inside a `<p>`. If this is the case, you can override the default markup by making use of the `foreground` snippet prop. Additionally, you can pass more complex data structures through the `slides` prop and specify how these data should be rendered with a custom `foreground` snippet. The contents of the corresponding item in the array will be passed to your foreground snippet along with the slide index. You can use this data in your custom markup like so:

```svelte
<script>
  import { Scrolly } from "@urbaninstitute/dataviz-components";

  let slides = [
    {
      title: "Slide 1",
      body: "This is the body of slide 1"
    },
    {
      title: "Slide 2",
      body: "This is the body of slide 2"
    },
    {
      title: "Slide 3",
      body: "This is the body of slide 3"
    }
  ];
</script>

<Scrolly {slides}>
  {#snippet background()}
    <div
      style="width: 100%; height: 100vh; color: var(--color-white); font-weight: var(--font-weight-bold); background: var(--color-blue); display: flex; align-items: center; justify-content: center;"
    >
      Scrolly background
    </div>
  {/snippet}

  {#snippet foreground(slide, index)}
    <div class="custom-foreground-text-box">
      <h2>{slide.title}</h2>
      <p>{slide.body}</p>
      <small>Slide {index + 1}</small>
    </div>
  {/snippet}
</Scrolly>
```

## Migration Guide

If you're upgrading from a previous version of this component, here are the breaking changes and how to update your code:

### 1. Background slot → background snippet

**Before:**

```svelte
<Scrolly {slides}>
  <div slot="background">Background content</div>
</Scrolly>
```

**After:**

```svelte
<Scrolly {slides}>
  {#snippet background()}
    <div>Background content</div>
  {/snippet}
</Scrolly>
```

### 2. Foreground slot → foreground snippet

**Before:**

```svelte
<Scrolly {slides}>
  <div slot="foreground" let:slide>
    <h2>{slide.title}</h2>
  </div>
</Scrolly>
```

**After:**

```svelte
<Scrolly {slides}>
  {#snippet foreground(slide, index)}
    <div>
      <h2>{slide.title}</h2>
    </div>
  {/snippet}
</Scrolly>
```

### 3. Context API: getContext → useScrollyState

**Before:**

```svelte
<script>
  import { getContext } from "svelte";

  const { index, offset, progress, slideHeight, slideWidth } = getContext("scrolly");

  // Use with $ store syntax
  console.log($index);
</script>
```

**After:**

```svelte
<script>
  import { useScrollyState } from "@urbaninstitute/dataviz-components";

  const scrolly = useScrollyState();

  // Use properties directly (reactive)
  console.log(scrolly.index);
</script>
```
